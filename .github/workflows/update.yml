name: Update Cursor

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

concurrency:
  group: update-cursor
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Configure Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Check for updates
        id: check
        run: |
          chmod +x ./update.sh
          ./update.sh

      - name: Update flake.lock
        if: steps.check.outputs.updated == 'true'
        run: |
          nix flake update
        env:
          NIX_CONFIG: "experimental-features = nix-command flakes"

      - name: Test build
        if: steps.check.outputs.updated == 'true'
        run: |
          nix build --accept-flake-config
        env:
          NIX_CONFIG: "experimental-features = nix-command flakes"
          NIXPKGS_ALLOW_UNFREE: "1"

      - name: Create Pull Request
        id: cpr
        if: steps.check.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update cursor ${{ steps.check.outputs.old_version }} -> ${{ steps.check.outputs.new_version }}"
          title: "Update Cursor to ${{ steps.check.outputs.new_version }}"
          body: |
            Automated update from Cursor's apt repository.
            
            **Version:** ${{ steps.check.outputs.old_version }} â†’ ${{ steps.check.outputs.new_version }}
            
            The build was tested successfully before creating this PR.
          branch: update-cursor-${{ steps.check.outputs.new_version }}
          delete-branch: true
          labels: |
            automated
            update

      - name: Enable auto-merge
        if: steps.cpr.outputs.pull-request-number
        run: gh pr merge --auto --squash "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
